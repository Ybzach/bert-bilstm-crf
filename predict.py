import os
import json
import torch
import numpy as np

from collections import namedtuple
from model import BertNer
from seqeval.metrics.sequence_labeling import get_entities
from transformers import BertTokenizerFast


def get_args(args_path, args_name=None):
    with open(args_path, "r", encoding="utf-8") as fp:
        args_dict = json.load(fp)
    # 注意args不可被修改了
    args = namedtuple(args_name, args_dict.keys())(*args_dict.values())
    return args


class Predictor:
    def __init__(self, data_name):
        self.data_name = data_name
        self.ner_args = get_args(os.path.join("./checkpoint/{}/".format(data_name), "ner_args.json"), "ner_args")
        self.ner_id2label = {int(k): v for k, v in self.ner_args.id2label.items()}
        self.tokenizer = BertTokenizerFast.from_pretrained(self.ner_args.bert_dir)
        self.max_seq_len = self.ner_args.max_seq_len
        self.device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
        self.ner_model = BertNer(self.ner_args)
        self.ner_model.load_state_dict(torch.load(os.path.join(self.ner_args.output_dir, "pytorch_model_ner.bin"), map_location="cpu"))
        self.ner_model.to(self.device)
        self.data_name = data_name

    
    def ner_tokenizer(self, text):
        tokenized_text = self.tokenizer(text,
                truncation=False,
                is_split_into_words=False
        )
        tokens = self.tokenizer.convert_ids_to_tokens(tokenized_text.input_ids)
        input_ids = tokenized_text.input_ids
        word_ids = tokenized_text.word_ids() 

        return tokens, input_ids, word_ids

    def get_entity(self, entity_start, entity_end, word_ids, tokens):
        entities = []
        for i in range(entity_start, entity_end + 1):
            entity_word_id = word_ids[i]
            entity = []
            for j, word_id in enumerate(word_ids):
                if word_id == entity_word_id:
                    entity_token = tokens[j]
                    if entity_token[:2] == '##':
                        entity_token = entity_token[2:]
                    entity.append(entity_token)
            entities.append("".join(entity))
        
        return " ".join(entities)
    

    def ner_predict(self, text):
        
        max_len = self.max_seq_len - 2
        result = {}
        tokens, input_ids, word_ids = self.ner_tokenizer(text)
        for i in range(0, len(input_ids), max_len):
            chunk_input_ids = input_ids[i:i+max_len]
            chunk_tokens = tokens[i:i+max_len]

            chunk_input_ids = [101] + chunk_input_ids + [102] # 101 = [CLS], 102 = [SEP]
            attention_mask = [1] * len(chunk_input_ids) + [0] * (self.max_seq_len - len(chunk_input_ids))
            chunk_input_ids = chunk_input_ids + [0] * (self.max_seq_len - len(chunk_input_ids))

            chunk_input_ids = torch.tensor(np.array([chunk_input_ids]))
            attention_mask = torch.tensor(np.array([attention_mask]))
            chunk_input_ids = chunk_input_ids.to(self.device)
            attention_mask = attention_mask.to(self.device)
            
            output = self.ner_model(chunk_input_ids, attention_mask)
            attention_mask = attention_mask.detach().cpu().numpy()
            length = sum(attention_mask[0])
            logits = output.logits
            logits = logits[0][1:length - 1]
            logits = [self.ner_id2label[i] for i in logits]
            entities = get_entities(logits)
            for ent in entities:
                ent_name = ent[0]
                ent_start = ent[1]
                ent_end = ent[2]
                if ent_name not in result:
                    result[ent_name] = [self.get_entity(ent_start, ent_end, word_ids, tokens)]
                else:
                    result[ent_name].append(self.get_entity(ent_start, ent_end, word_ids, tokens))
        return result


if __name__ == "__main__":
    data_name = "resume"
    predictor = Predictor(data_name)
    if data_name == "fyp":
        texts = [
            "Job Description: At Bank of America, we are guided by a common purpose to help make financial lives better through the power of every connection. Responsible Growth is how we run our company and how we deliver for our clients, teammates, communities and shareholders every day. One of the keys to driving Responsible Growth is being a great place to work for our teammates around the world. We’re devoted to being a diverse and inclusive workplace for everyone. We hire individuals with a broad range of backgrounds and experiences and invest heavily in our teammates and their families by offering competitive benefits to support their physical, emotional, and financial well-being. Bank of America believes both in the importance of working together and offering flexibility to our employees. We use a multi-faceted approach for flexibility, depending on the various roles in our organization. Working at Bank of America will give you a great career with opportunities to learn, grow and make an impact, along with the power to make a difference. Join us! Job Description: This job is responsible for developing and delivering complex requirements to accomplish business goals. Key responsibilities of the job include ensuring that software is developed to meet functional/non-functional requirements, coding solutions, and unit testing. Job expectations include an awareness of the development practices in the industry. The SME will leverage Mortgages securities risk subject matter expertise and Python/Quartz skills to onboard the Repo Mortgage securities in the strategic SFRC end of day framework. Responsibilities: - Codes solutions and unit test to deliver a requirement/story per the defined acceptance criteria - Executes automated test suites (integration, regression, performance); collect results and flag issues - Documents and communicates required information for deployment, maintenance, support, and business functionality - Adheres to team delivery/release process and cadence pertaining to code deployment and release - Contributes to story refinement and definition of requirements Required Skills: Senior Resource with Good Experience with Java Desired Skills: SQL Skills: - Application Development - Automation - Collaboration - DevOps Practices - Solution Design - Agile Practices - Architecture - Result Orientation - Solution Delivery Process - User Experience Design - Analytical Thinking - Data Management - Risk Management - Technical Strategy Development - Test Engineering Minimum Education Requirement: Bachelors degree or equivalent work experience Shift: 1st shift (United States of America) Hours Per Week: 40 ",
            "Join our team, located in the stunning city of Vancouver, Canada, where we foster a culture of growth and diversity. Our team is responsible for the highly scalable Microsoft Forms service, which serves customers worldwide with SAAS architecture. With Microsoft Forms, information workers and educators can easily collect survey and assessment results, and generate insights through automatic data analysis and AI, whether on desktop or mobile.  We Are Looking To Hire a Software Engineer I Who Is Seeking New Challenges And Opportunities For Growth In One Or More Of The Following Areas - Scalable SAAS service utilizing public cloud services. - Scalable web client utilizing open technology like React, Redux, Webpack. - Big data and AI. - Technical leadership and collaboration with Microsoft teams in the US and worldwide. - Improving large-scale system architecture and infrastructure. - Customer obsession and engagement. If this is you, we invite you to join our mission and be part of our exciting journey. Check out our latest blog post and videos to see what Microsoft Forms team in Vancouver has been up to lately: Microsoft Forms: Connecting with Customers to Empower Innovation - Microsoft Vancouver Microsoft’s mission is to empower every person and every organization on the planet to achieve more. As employees we come together with a growth mindset, innovate to empower others, and collaborate to realize our shared goals. Each day we build on our values of respect, integrity, and accountability to create a culture of inclusion where everyone can thrive at work and beyond. Embody our Culture and Values Responsibilities - Understand user requirements and design solutions to meet those needs. - Write and debug code for various software products or features. - Deploy features and monitor their performance in live services. - Follow engineering best practices throughout the software development lifecycle. - Act as a Designated Responsible Individual (DRI) for simple system/product/service issues, escalating complex problems as needed. - Reviews current developments and proactively seeks new knowledge that will improve the availability, reliability, efficiency, observability, and performance of products while also driving consistency in monitoring and operations at scale. Qualifications Required Qualifications - Bachelor's Degree in Computer Science, or related technical discipline with proven experience coding in languages including, but not limited to, C, C++, C#, Java, JavaScript, or Python - - OR equivalent experience. Preferred Qualifications - -  Bachelor's Degree in Computer Science or related technical field AND 1+ year(s) technical engineering experience with coding in languages including, but not limited to, C, C++, C#, Java, JavaScript, or Python - OR Master's Degree in Computer Science or related technical field with proven experience coding in languages including, but not limited to, C, C++, C#, Java, JavaScript, or Python - OR equivalent experience. Software Engineering IC2 - The typical base pay range for this role across Canada is CAD $61,500 - CAD $121,200 per year. Find Additional Pay Information Here https://careers.microsoft.com/v2/global/en/canada-pay-information.html Microsoft will accept applications for the role until May 14, 2023. Microsoft is an equal opportunity employer. Consistent with applicable law, all qualified applicants will receive consideration for employment without regard to age, ancestry, citizenship, color, family or medical care leave, gender identity or expression, genetic information, immigration status, marital status, medical condition, national origin, physical or mental disability, political affiliation, protected veteran or military status, race, ethnicity, religion, sex (including pregnancy), sexual orientation, or any other characteristic protected by applicable local laws, regulations and ordinances. If you need assistance and/or a reasonable accommodation due to a disability during the application process, read more about requesting accommodations. ",
            "What We're Looking For We're seeking a talented individual who is a true self-starter. You'll play a vital role in all major technical decisions, comfortable building new systems from scratch during a period of rapid growth. Requirements The Role: - Lead the design, architecture, and implementation of backend systems - Drive advancements in our backend architecture to anticipate growth - Take technical ownership of features, driving product progression - Collaborate closely with the product team to drive impactful changes - Present cross-team launches and updates at company-wide check-ins You Should be: - Action-oriented. You thrive on delivering results - Backend-focused. You excel in building backend services over frontend components - 3+ years of problem-solving experience - Proficient in building and scaling NoSQL databases (Familiarity with Firebase is advantageous) - Skilled in React.js (React, Redux, CSS/SASS, HTML, Typescript) - Strong communication skills - Proven track record of timely and budget-compliant feature deliveries - Organized, self-driven, and proactive Benefits - Weekly workouts with the team - Comprehensive health/dental/vision coverage - Unlimited PTO and sick leave Salary Range: $80,000 - $120,000 annually, depending on experience.",
            "Since 2010 Synergisticit has helped Jobseekers differentiate themselves by providing candidates the requisite skills and experience to outperform at interviews and clients. Here at SynergisticIT We just don't focus on getting you a Job we make careers. All Positions are open for all visas and US citizens We at Synergisticit understand the problem of the mismatch between employer's requirements and Employee skills and that's why since 2010 we have helped 1000's of candidates get jobs at technology clients like apple, google, Paypal, western union, Client, visa, walmart lab s etc to name a few. We have an excellent reputation with the clients. Currently, We are looking for entry-level software programmers, Java Full stack developers, Python/Java developers, Data analysts/ Data Scientists, Machine Learning engineers for full time positions with clients. Who Should Apply Recent Computer science/Engineering /Mathematics/Statistics or Science Graduates or People looking to switch careers or who have had gaps in employment and looking to make their careers in the Tech Industry. We assist in filing for STEM extension and also for H1b and Green card filing to Candidates If you applied for a job and got emails from our Job Placement Program team please email them or ask them to take you off their distribution list and make you unavailable as they share the same database with the client servicing team. please check the below links to see success outcomes of our candidates and our participation at different Tech industry events and how we are different from other organizations in helping Jobseekers secure Tech careers (url removed) We regularly interact with the Top Tech companies to give our candidates a competitive advantage-Please see us exhibiting at Oracle Cloud world /Oracle Java one (Las vegas) -2023/2022 and at Gartner Data Analytics Summit (Florida)-2023 (url removed) (url removed) For preparing for interviews please visit (url removed) We are looking for the right matching candidates for our clients Please apply via the job posting REQUIRED SKILLS For Java /Full Stack/Software Programmer Bachelors degree or Masters degree in Computer Science, Computer Engineering, Electrical Engineering, Information Systems, IT Highly motivated, self-learner, and technically inquisitive Experience in programming language Java and understanding of the software development life cycle Project work on the skills Knowledge of Core Java , javascript , C++ or software programming Spring boot, Microservices, Docker, Jenkins and REST API's experience Excellent written and verbal communication skills For data Science/Machine learning Positions Required Skills Bachelors degree or Masters degree in Computer Science, Computer Engineering, Electrical Engineering, Information Systems, IT Project work on the technologies needed Highly motivated, self-learner, and technically inquisitive Experience in programming language Java and understanding of the software development life cycle Knowledge of Statistics, SAS, Python, Computer Vision, data visualization tools Excellent written and verbal communication skills Preferred skills: NLP, Text mining, Tableau, PowerBI, SAS, Tensorflow If you get emails from our Job Placement team and are not interested please email them or ask them to take you off their distribution list and make you unavailable as they share the same database with the client servicing team who only connect with candidates who are matching client requirements. No phone calls please. Shortlisted candidates would be reached out. No third party or agency candidates or c2c candidates",
            "Job Description Quevera is seeking a to join an exciting, collaborative and innovative team. A place where you are positioned for More than Just a Job. Where leadership partners with you, seek to cultivate and support career development, encouraging growth from within while striving to foster a diverse environment that improves individual and organizational performance. Highlights Of Working For Quevera Are - Quevera employees voted Quevera as a TOP EMPLOYER in the Baltimore /DC area for 2020 (ranked #8 out of 150 companies) and 2022 (ranked #5 out of 150 companies). - Yearly $5,000 towards education/training. - Employees are in control of their career path through our Career Pathway Program. - Family and corporate events - Excellent health care coverage (100% paid premium option) and 401K matching (up to 4%). - And many more! - Q-Culture Video - Q-Careers Required Qualifications - Experience in either Java or Python - IAT Level 2 Certification Preferred Qualifications - Experience in Full stack - Shell Scripting - Docker - Typescript, angular 14+ - MongoDB, Kubernetes (Docker) - Relational data bases (MySQL, Postgres, Oracle, Sybase, etc…) Quevera is an equal opportunity/affirmative action employer. All qualified applicants will receive consideration for employment without regard to sex, gender identity, sexual orientation, race, color, religion, national origin, disability, protected veteran status, age or any other characteristic protected by law.",
            "About CMG “Companies access the capital markets to raise money that will ultimately drive expansion, innovation, and employment growth, which is why we have built an integrated capital markets platform that will optimize the deal flow process for all market participants.” Greg Ingram, CMG CEO, and co-founder. Capital Markets Gateway (CMG) is a FinTech start-up that is transforming the equity capital markets (ECM). The capital raising process is riddled with inefficiencies and operational risk. CMG is creating a digital marketplace that connects investors and underwriters via a neutral platform that delivers integrated ECM data and analytics. CMG’s platform streamlines workflows and delivers information and analytics in real-time providing users with long-desired speed to market and analysis vital to decision making. The Role: As part of our continuous efforts to revolutionize the capital markets landscape, we are offering an exciting opportunity for a motivated and talented Software Engineer to join our team. As a Capital Markets Software Engineer, you will have the unique opportunity to contribute to pioneering ideas at the intersection of finance, software engineering, artificial intelligence (AI), data science, and programming. You will work closely with our teams and industry experts, playing a crucial role in the development of groundbreaking solutions that will shape the future of capital markets. What you will be responsible for: - Assist in programming and the creation of software tools and applications aimed at enhancing capital markets operations - Apply AI and data science techniques to analyze financial data, detect trends, and generate actionable insights - Work collaboratively with cross-functional teams to implement and test innovative solutions What are the qualifications: - Bachelor's or Master's degree in a relevant field preferred (e.g., Computer Science, Finance, Data Science, Engineering, etc.) - Proficiency in Python and C# is required, experience with JavaScript and Typescript is preferred - Familiarity with AI/ChatGPT, TensorFlow, and data science methodologies, including machine learning, data analysis, and data visualization - Experience with JSON, REST - Strong problem-solving skills and a genuine passion for innovation - Effective communication skills and the ability to thrive in a collaborative team environment - While not mandatory, an understanding of financial concepts and capital markets is advantageous Our Tech Stack: - DotNetCore for our web framework - Entity Framework for our ORM - Docker + Kubernetes for microservice orchestration - PostgreSQL for relational data - Redis Cache for distributed caching - GraphQL - Microsoft Azure services for hosting and operations - React/Redux with TypeScript on our front-end Our Values: - We innovate with purpose - We focus on outcomes vs. output - We believe diverse and inclusive teams fuel innovation - We are humble yet candid - We do right by the customer What we offer: - Healthcare: Medical, Dental & Vision - 401K Company Match - Life Insurance - Flexible Spending & Health Savings Account - Unlimited PTO - Equity - Remote Working Environment - Interactive Training Programs - STD & LTD - Education Reimbursement Program - Employee Referral Bonus - Paid time off for volunteering in our communities - Charitable giving programs chosen by our customers - Health and Wellness Programs Compensation Information: The estimated salary range for this role is $80,000 - $110,000. The successful candidate’s salary will be determined by non-discriminatory factors such as skills and experience. Additionally, this role is eligible to participate in our benefits program including health, dental, vision, 401K, paid time off and our equity plan. This employer participates in E-Verify and will provide the federal government with your Form 1-9 information to confirm you are authorized to work in the US. CMG embraces our ongoing commitment to building a culture reflecting the people, perspectives, and passions it represents. We will accept nothing less than equity, inclusion, and belonging for all. With the only constant in life being change, we will always listen, learn, and improve for the betterment of our teams, customers, and communities. CMG is proud to be an Equal Opportunity and Affirmative Action Employer.",
            "About The Role & Team On any given day at Disney Entertainment & ESPN Technology, we’re reimagining ways to create magical viewing experiences for the world’s most beloved stories while also transforming Disney’s media business for the future. Whether that’s evolving our streaming and digital products in new and immersive ways, powering worldwide advertising and distribution to improve flexibility and efficiency, or delivering Disney’s unmatched entertainment and sports content, every day is a moment to make a difference to partners and to hundreds of millions of people around the world. A few reasons why we think you’d love working for Disney Entertainment & ESPN Technology - Building the future of Disney’s media business: DE&E Technologists are designing and building the infrastructure that will power Disney’s media, advertising, and distribution businesses for years to come. - Reach & Scale: The products and platforms this group builds and operates delight millions of consumers every minute of every day – from Disney+ and Hulu, to ABC News and Entertainment, to ESPN and ESPN+, and much more. - Innovation: We develop and execute groundbreaking products and techniques that shape industry norms and enhance how audiences experience sports, entertainment & news. What You Will Do As a member of the Experience Delivery – Entertainment team, you will build and support the tools, services and distribution APIs that deliver content to our websites including Disney.com, StarWars.com and over 100 domestic and international sites. We are looking for a passionate, impactful technologist who seeks to bring the best out in themselves and those around them. Someone who can provide a new perspective and innovative insight to our initiatives. You’ll make a phenomenal fit for our team if you like to do these things: - Collaborate with product managers and fellow engineers in the design and implementation of systems delivering high throughput experiences. - Contribute to cross-team architecture discussions. - Analyze and resolve complex engineering problems involving high trafficked web and mobile application services and APIs. - Work with the team to iteratively improve development practices and processes. - Help with full-stack development when needed. - Research and experiment with the latest and greatest technologies to identify and apply them to current and future projects. - Work with the team to iteratively improve development practices and processes. - Contribute to code reviews. You Will ... - Be involved in the requirements gathering, analysis, design, development, testing, deployment, and maintenance of systems that support or enhance other applications within our environment. - Collaborate & troubleshoot with the rest of the team in the analysis and resolution of hard engineering problems involving high trafficked web application services and API’s. - Think of new ways to help make our data platform more scalable, resilient, and reliable and then work across our team to put your ideas into action. - Research and learn new technologies. Required Qualifications & Skills - Java programming experience with a desire to learn Ruby. - Knowledge of NoSQL and/or relational databases. - Understanding of APIs, data structures, algorithms, and object-oriented programming concepts. - Motivated self-starter with the ability to learn and adapt to new technologies. - Strong analytical skills as well as solid capabilities for debugging and troubleshooting. - Good communication skills and attention to detail. Preferred Qualifications - Exposure to cloud-based technologies such as AWS EC2, ECS, SQS, S3, DynamoDB, Lambda, CloudFormation, Terraform, etc. - Experience with the Spring, Ruby on Rails, MySQL, and/or MongoDB. - Understanding of full-stack development with HTML, CSS, JavaScript, React, and RESTful APIs/GraphQL. Education - Bachelor’s degree in Computer Science, Information Systems, Software, Electrical or Electronics Engineering, or comparable field of study, and/or equivalent work experience The hiring range for this position in Glendale, CA is $93,400 to $125,200 per year based on a 40 hour work week. The amount of hours scheduled per week may vary based on business needs. The base pay actually offered will take into account internal equity and also may vary depending on the candidate’s geographic region, job-related knowledge, skills, and experience among other factors. A bonus and/or long-term incentive units may be provided as part of the compensation package, in addition to the full range of medical, financial, and/or other benefits, dependent on the level and position offered.",
            "Position Description The manager is looking for a Software Engineer to work with the team’s Infrastructure Engineers to find innovative ways to focus on automation for manual processes and improve existing self-service tools. Works on a product team and supports product design by planning its work, coordinating with others, and writing and testing code to deliver moderately complex functionality on a complete product or significant portion of a product it supports. Duties Include - Develops, codes, configures, and tests programs and systems. - Evaluates and implements enhancement design solutions to improve cost, quality, and performance of software applications. - Analyzes assignments and determines software specifications that must be fulfilled to achieve objectives. - Executes necessary documentation, as directed, or needed. - Collaborates with other relevant stakeholders and team members to ensure that features meet business needs. - Follows industry-standard agile software design methodology for development and documentation. Desired Skills And Experience - Experience in the design, development, testing and integration and deployment of software solutions leveraging change management processes (1 - 3 years). - Experience with cloud (AWS) (1 - 3 years). - Experience with REACT (1 - 3 years). - Experience with Rest APIs (1 - 3 years). - Good understanding of databases (i.e. SQL, DB2, etc) (1 - 3 years). - Experience with GitHub (1 - 3 years). - Experience using scripting tools – Ruby, Javascript, Python, Bast, etc (1 - 3 years). - Experience using Node.js, React Angular (1 - 3 years). - Proficient in interpersonal communication, collaboration and building working Relationships. - Strong understanding of Agile practices. - Previous experience in programming and software development (1 - 3 years). - Software development processes experience (1 - 3 years). - Participating in Agile Development (1 - 3 years). - Experience working in an Agile Environment (1 - 3 years). Education - Degree in an Engineering/Technology discipline or equivalent experience - University Degree (4 years or equivalent). - Degree in an Information Technology discipline or equivalent experience - University Degree (4 years "

        ]
    elif data_name == "resume":
        texts = [
                "Bachelor of Artificial Intelligence (Hons.) Multimedia University (Melaka) Foundation in Information Technology Multimedia University (Melaka) Present 3.42 2019 3.45 Sijil Pelajaran Malaysia (SPM) SMK St. Francis Institution 2018",
                "Microsoft – WORD, EXCEL, POWER POINT Programming – C++, JAVA, PYTHON, PHP, LISP",
                "Globe OSS July 2023 – October 2023 (Expected) Intern Subang Jaya, Selangor Collaborated on a data migration initiative, playing a key role in transitioning 500+ views and 200 stored procedures from an SQL Server On-Premises database to the MySQL Cloud Base database. Engineered and implemented dynamic charts for a geospatial project with JavaScript, enhancing data visualization capabilities and enabling the comparison of crucial KPIs across regions in Malaysia for different telecommunication service providers. SPADE Interactive February 2022 – May 2022 Freelance Developer / IT Support Kuala Lumpur SPADE Interactive is a web app that aims to create an interactive learning environment that is targeted for kindergarten students. Digitalized 96 pages of traditional textbook materials into interactive teaching materials that are targeted for a kindergarten learning environment.",
            ]
    for text in texts:
        ner_result = predictor.ner_predict(text)
        print("文本>>>>>：", text)
        print("实体>>>>>：", ner_result)
        print("="*100)


